<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>G3 Macro Radar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
    }
    .subtitle {
      text-align: center;
      color: #94a3b8;
      margin-bottom: 30px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .card {
      background: #020617;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
    }
    .card h3 {
      margin-top: 0;
      font-size: 14px;
      color: #94a3b8;
    }
    .value {
      font-size: 28px;
      font-weight: bold;
      margin-top: 10px;
    }
    .state {
      font-size: 36px;
      font-weight: 800;
    }
    .portfolio {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .portfolio li {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #1e293b;
    }
    footer {
      text-align: center;
      margin-top: 40px;
      color: #64748b;
      font-size: 12px;
    }
    .debug {
      margin-top: 20px;
      padding: 10px;
      background: #020617;
      border-radius: 10px;
      color: #94a3b8;
      font-size: 12px;
      word-break: break-all;
    }
  </style>
</head>
<body>
  <h1>üì° G3 Macro Radar</h1>
  <div class="subtitle">Live Global Liquidity & Risk Dashboard</div>

  <div class="grid">
    <div class="card">
      <h3>Market State</h3>
      <div id="state" class="state">--</div>
    </div>
    <div class="card">
      <h3>Liquidity Index (LI)</h3>
      <div id="li" class="value">--</div>
    </div>
    <div class="card">
      <h3>Risk Index (RI)</h3>
      <div id="ri" class="value">--</div>
    </div>
    <div class="card">
      <h3>Transition Probability</h3>
      <div id="prob" class="value">--</div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Recommended Portfolio</h3>
      <ul id="portfolio" class="portfolio"></ul>
    </div>
    <div class="card">
      <h3>LI / RI Visualization</h3>
      <canvas id="radarChart"></canvas>
    </div>
  </div>

  <footer>
    Auto-updated daily via GitHub Actions ¬∑ Powered by G3 Macro Engine
  </footer>

  <div id="debug" class="debug">Loading data...</div>

  <script>
    let chartInstance = null;

    function getBasePath() {
      const parts = window.location.pathname.split("/");
      if (parts.length > 2) {
        return "/" + parts[1] + "/";
      }
      return "/";
    }

    const DATA_URL = getBasePath() + "reports/latest.json";

    async function loadData() {
      const debugBox = document.getElementById("debug");
      try {
        const url = DATA_URL + "?t=" + Date.now();
        debugBox.innerText = "Fetching: " + url;

        const res = await fetch(url);
        if (!res.ok) {
          throw new Error("HTTP " + res.status + " " + res.statusText);
        }

        const data = await res.json();

        document.getElementById("state").innerText = data.state || "--";
        document.getElementById("li").innerText = (data.li ?? 0).toFixed(4);
        document.getElementById("ri").innerText = (data.ri ?? 0).toFixed(4);
        document.getElementById("prob").innerText =
          (data.transition_probability ?? "--") + "%";

        const ul = document.getElementById("portfolio");
        ul.innerHTML = "";
        if (data.portfolio) {
          Object.entries(data.portfolio).forEach(([k, v]) => {
            const li = document.createElement("li");
            li.innerHTML = `<span>${k}</span><span>${v}</span>`;
            ul.appendChild(li);
          });
        }

        renderChart(data.li || 0, data.ri || 0);

        debugBox.innerText =
          "Last update: " +
          (data.timestamp || "unknown") +
          "\nPath: " +
          DATA_URL;
      } catch (e) {
        debugBox.innerText =
          "‚ö†Ô∏è Failed to load data\n" +
          "Path tried: " +
          DATA_URL +
          "\nError: " +
          e.message;
        console.error(e);
      }
    }

    function renderChart(li, ri) {
      const ctx = document.getElementById("radarChart").getContext("2d");

      if (chartInstance) {
        chartInstance.destroy();
      }

      chartInstance = new Chart(ctx, {
        type: "radar",
        data: {
          labels: ["Liquidity", "Risk"],
          datasets: [
            {
              label: "Market Condition",
              data: [li * 100, ri * 100],
              fill: true,
              backgroundColor: "rgba(56, 189, 248, 0.2)",
              borderColor: "rgba(56, 189, 248, 1)",
              pointBackgroundColor: "rgba(56, 189, 248, 1)"
            }
          ]
        },
        options: {
          scales: {
            r: {
              beginAtZero: true,
              max: 100,
              ticks: { display: false }
            }
          }
        }
      });
    }

    loadData();
    setInterval(loadData, 60000); // ÊØèÂàÜÈíüËá™Âä®Âà∑Êñ∞
  </script>
</body>
</html>

